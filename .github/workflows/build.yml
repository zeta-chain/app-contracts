name: Build

on:
  push:
    branches:
      - main
      - cicd/docker-build
  pull_request:
    branches:
      - main



env:
  GITHUB_REF_NAME: "$(echo ${{ github.ref_name }} | tr '//' '-')"

jobs:
  build-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v3

    - name: setup-git-credentials
      uses: de-vri-es/setup-git-credentials@v2.0.8
      with:
        credentials: ${{ secrets.PAT_GITHUB_SERVICE_ACCT }}

    - name: Build, tag, and push docker images
      uses:  ./.github/actions/build-docker-images
      with:
        DOCKER_FILENAME: Dockerfile
        REPOSITORY_NAME: zeta-node
        IMAGE_TAG: ${{ env.TAG_NAME }}
        GHCR_USERNAME: ${{ secrets.PAT_GITHUB_SERVICE_ACCT_USERNAME }}
        GHCR_TOKEN: ${{ secrets.PAT_GITHUB_SERVICE_ACCT }}
